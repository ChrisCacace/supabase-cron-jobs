name: Debug Cron Issue

on:
  schedule:
    - cron: '*/2 * * * *'  # Every 2 minutes
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Comprehensive Debug Info
        run: |
          echo "🚨 CRON DEBUG REPORT 🚨"
          echo "========================"
          echo ""
          echo "📋 EVENT INFORMATION:"
          echo "Event type: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Visibility: ${{ github.repository_visibility }}"
          echo "Default branch: ${{ github.event.repository.default_branch }}"
          echo "Current branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          
          echo "⏰ TIMING INFORMATION:"
          echo "Current UTC: $(date -u)"
          echo "Current local: $(date)"
          echo "Timezone: $(timedatectl show --property=Timezone --value 2>/dev/null || echo 'Unknown')"
          echo ""
          
          echo "🔧 REPOSITORY STATUS:"
          echo "Last commit: $(git log -1 --format='%H %s' --date=short)"
          echo "Branch: $(git branch --show-current)"
          echo "Remote: $(git remote get-url origin)"
          echo ""
          
          echo "📁 WORKFLOW FILES:"
          ls -la .github/workflows/ || echo "No workflows directory found"
          echo ""
          
          echo "🌐 GITHUB API TEST:"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }} | \
               jq -r '.name, .private, .default_branch, .updated_at' 2>/dev/null || \
               echo "GitHub API test failed"
          echo ""
          
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "✅ SCHEDULED RUN DETECTED!"
            echo "Cron is working correctly."
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "⚠️  MANUAL TRIGGER"
            echo "This was triggered manually."
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "📤 PUSH TRIGGER"
            echo "This was triggered by a push."
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "🔀 PULL REQUEST TRIGGER"
            echo "This was triggered by a PR."
          else
            echo "❓ UNKNOWN TRIGGER: ${{ github.event_name }}"
          fi
          
          echo ""
          echo "🔍 NEXT STEPS:"
          echo "1. Check if this appears in Actions tab"
          echo "2. Look for scheduled runs every 2 minutes"
          echo "3. Check repository settings"
          echo "4. Verify GitHub Actions service status"
          
      - name: Test HTTP connectivity
        run: |
          echo "🌐 Testing external connectivity..."
          
          # Test basic HTTP
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" https://httpbin.org/get || echo "HTTP test failed"
          
          # Test GitHub API
          curl -s -o /dev/null -w "GitHub API Status: %{http_code}\n" https://api.github.com/zen || echo "GitHub API test failed"
          
      - name: Create debug artifact
        run: |
          echo "Debug run at: $(date -u)" > debug-info.txt
          echo "Event: ${{ github.event_name }}" >> debug-info.txt
          echo "Repository: ${{ github.repository }}" >> debug-info.txt
          echo "Branch: ${{ github.ref_name }}" >> debug-info.txt
          
      - name: Upload debug info
        uses: actions/upload-artifact@v3
        with:
          name: debug-info-${{ github.run_id }}
          path: debug-info.txt 